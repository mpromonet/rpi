<!DOCTYPE html>
<meta charset="utf-8" />
<title>WebSocket Test</title>
<script language="javascript" type="text/javascript">

  var out = function(message) {
    var div = document.createElement('div');
    div.innerHTML = message;
    document.getElementById('output').appendChild(div);
  };

  window.onload = function() {
    var url = 'ws://' + location.host + '/ws';
    var num_messages = 0;

    websocket = new WebSocket(url);
    websocket.binaryType = 'arraybuffer';
    websocket.onopen = function(ev) {
      out('CONNECTED');
      var msg = 'sub';
      out('SENT: ' + msg);
      websocket.send(msg);
    };
    websocket.onclose = function(ev) {
      out('DISCONNECTED');
    };
    websocket.onmessage = function(ev) {
      if (!ev.data) {
        out('<span style="color: blue;">PING... </span>');
      } else if (typeof(ev.data)=="string") {
        out('<span style="color: blue;">'+ev.data+'</span>');
      } else {
      
	var bytes = new Uint8Array(ev.data);	
	var binary = "";
	for(i=0;i<bytes.length;i++) binary += String.fromCharCode(bytes[i]);
	
      	var img = new Image();
	img.src = 'data:image/jpeg;base64,' + btoa(binary);
	img.onload = function()
	{
		document.getElementById('canvas').getContext("2d").drawImage(this,0,0);
	}	
        num_messages++;
      }
      if (num_messages > 300) {
        websocket.send('exit');
      }
    };
    websocket.onerror = function(ev) {
      out('<span style="color: red; ">ERROR: </span> ' + ev.data);
    };
  };
</script>
<style> div {font: small Verdana; } </style>
<h2>Mongoose WebSocket Test</h2>

<canvas id="canvas" width="640"  height="480"></canvas>
<div id="output"></div>
</html>
